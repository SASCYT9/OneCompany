/**
 * Generate brandLogos.ts from existing logo files
 * Run: node scripts/generate-brand-logos-map.js
 */

const fs = require('fs');
const path = require('path');

const LOGOS_DIR = path.join(__dirname, '..', 'public', 'logos');
const OUTPUT_FILE = path.join(__dirname, '..', 'src', 'lib', 'brandLogos.ts');

// Brand name to filename mapping for known mismatches
const NAME_TO_SLUG_OVERRIDES = {
  'ABT': 'abt',
  'AC Schnitzer': 'ac-schnitzer',
  'AMS / Alpha Performance': 'ams-alpha-performance',
  'H&R': 'handr',
  'KW': 'kw',
  '√ñhlins': 'ohlins',
  '3D Design': '3d-design',
  'FI Exhaust': 'fi-exhaust',
  'IPe exhaust': 'ipe-exhaust',
  'Akrapoviƒç': 'akrapovic',
};

function slugify(name) {
  return name
    .toLowerCase()
    .replace(/√∂/g, 'o')
    .replace(/ƒç/g, 'c')
    .replace(/[&]/g, 'and')
    .replace(/[']/g, '')
    .replace(/[\/]/g, '-')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '');
}

function getSlugFromFilename(filename) {
  return filename.replace(/\.(svg|png|webp|avif|jpg|jpeg)$/i, '');
}

function brandNameToSlug(brandName) {
  if (NAME_TO_SLUG_OVERRIDES[brandName]) {
    return NAME_TO_SLUG_OVERRIDES[brandName];
  }
  return slugify(brandName);
}

// Read brands.ts to get all brand names
function getBrandNames() {
  const brandsFile = path.join(__dirname, '..', 'src', 'lib', 'brands.ts');
  const content = fs.readFileSync(brandsFile, 'utf-8');
  
  const brandNames = [];
  
  // Match name: '...' or name: "..." patterns, allowing escaped quotes.
  // Note: brand names may contain apostrophes (e.g. "Matt's carbon") so we
  // must not stop on the wrong quote type.
  const regex = /name:\s*(?:'((?:\\.|[^'])*)'|"((?:\\.|[^"])*)")/g;
  let match;
  while ((match = regex.exec(content)) !== null) {
    const raw = (match[1] ?? match[2] ?? '').trim();
    if (!raw) continue;
    // Unescape common sequences found in TS string literals.
    const name = raw.replace(/\\'/g, "'").replace(/\\\"/g, '"').replace(/\\\\/g, '\\');
    brandNames.push(name);
  }
  
  return [...new Set(brandNames)];
}

function main() {
  console.log('üîç Scanning logo files...\n');
  
  // Get all logo files
  const files = fs.readdirSync(LOGOS_DIR)
    .filter(f => /\.(svg|png|webp|avif|jpg|jpeg)$/i.test(f) && fs.statSync(path.join(LOGOS_DIR, f)).size > 500);
  
  console.log(`Found ${files.length} logo files\n`);
  
  // Create slug -> file mapping (prefer SVG over PNG over others)
  const slugToFile = {};
  const fileOrder = ['svg', 'webp', 'png', 'avif', 'jpg', 'jpeg'];
  
  for (const file of files) {
    // Be forgiving about filename casing/spaces: normalize filenames into slugs
    // so that e.g. "ABT.png" or "Deikin Logo.webp" can still match "abt"/"deikin".
    const slug = slugify(getSlugFromFilename(file));
    const ext = file.split('.').pop().toLowerCase();
    
    if (!slugToFile[slug] || fileOrder.indexOf(ext) < fileOrder.indexOf(slugToFile[slug].split('.').pop())) {
      slugToFile[slug] = file;
    }
  }
  
  // Get brand names from brands.ts
  const brandNames = getBrandNames();
  console.log(`Found ${brandNames.length} brand names in brands.ts\n`);
  
  // Build logo map
  const logoMap = {};
  let matched = 0;
  let unmatched = 0;
  
  for (const brandName of brandNames) {
    const slug = brandNameToSlug(brandName);
    
    if (slugToFile[slug]) {
      logoMap[brandName] = `/logos/${slugToFile[slug]}`;
      matched++;
    } else {
      // Try alternative slugs
      const altSlug = slug.replace(/-/g, '');
      if (slugToFile[altSlug]) {
        logoMap[brandName] = `/logos/${slugToFile[altSlug]}`;
        matched++;
      } else {
        unmatched++;
        console.log(`‚ö†Ô∏è No logo for: ${brandName} (expected: ${slug})`);
      }
    }
  }
  
  console.log(`\nüìä Results:`);
  console.log(`   ‚úÖ Matched: ${matched}`);
  console.log(`   ‚ö†Ô∏è Unmatched: ${unmatched}`);
  
  // Generate TypeScript file
  const sortedEntries = Object.entries(logoMap).sort((a, b) => 
    a[0].toLowerCase().localeCompare(b[0].toLowerCase())
  );
  
  const tsContent = `// Auto-generated by generate-brand-logos-map.js
// Last updated: ${new Date().toISOString()}
// Total logos: ${sortedEntries.length}

export const BRAND_LOGO_MAP: Record<string, string> = {
${sortedEntries.map(([name, logoPath]) => `  '${name.replace(/'/g, "\\'")}': '${logoPath}'`).join(',\n')}
};

export function getBrandLogo(brandName: string): string {
  // Try exact match first
  if (BRAND_LOGO_MAP[brandName]) {
    return BRAND_LOGO_MAP[brandName];
  }
  
  // Try case-insensitive match
  const lowerName = brandName.toLowerCase();
  for (const [key, value] of Object.entries(BRAND_LOGO_MAP)) {
    if (key.toLowerCase() === lowerName) {
      return value;
    }
  }
  
  // Return placeholder
  return '/images/logo-placeholder.svg';
}
`;
  
  fs.writeFileSync(OUTPUT_FILE, tsContent);
  console.log(`\nüìù Written ${sortedEntries.length} entries to brandLogos.ts`);
}

main();
